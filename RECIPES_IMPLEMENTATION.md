# Детальна імплементація рецептів виробництва

## Загальна структура

Кожен рецепт складається з:
- **Назва рецепту** (name)
- **Цільовий продукт** (target_product_id) - готова вагова продукція
- **Очікуваний вихід** (expected_yield_min, expected_yield_max) - % від початкової ваги
- **Кроки виробництва** (recipe_steps) - послідовність операцій

Структура кроку:
```
step_order - порядковий номер (1, 2, 3...)
step_type - тип операції (trim, salt, dry, press, mix...)
step_name - назва кроку українською
duration_days - тривалість в днях (може бути дробове число)
parameters - JSON з додатковими параметрами
```

---

## 1. Бастурма класична

**Готовий продукт:** Бастурма класична вагова (ID: 133)  
**Очікуваний вихід:** 73-78%  
**Сировина:** Яловичина вищій ґатунок

### Технологічний процес (8 кроків):

#### Крок 1: Обрізка та підготовка
- **Тип:** `trim`
- **Тривалість:** 0 днів (миттєво)
- **Параметри:**
  ```json
  {
    "trim_percent_min": 0,
    "trim_percent_max": 0
  }
  ```
- **Опис:** Початкова підготовка м'яса, обрізки не очікуються для вищого гатунку

#### Крок 2: Засолка
- **Тип:** `salt`
- **Тривалість:** 3 дні
- **Параметри:**
  ```json
  {
    "salt_per_100kg": 20.67,
    "water_per_100kg": 66.67
  }
  ```
- **Опис:** 
  - На 100 кг м'яса: 20.67 кг солі + 66.67 л води
  - На 15 кг (приклад): 3.1 кг солі + 10 л води
  - Масажер працює 40 хв/добу
  - М'ясо збільшується на ~15% після засолки

#### Крок 3: Промивка
- **Тип:** `wash`
- **Тривалість:** 0.125 днів (3 години)
- **Параметри:**
  ```json
  {
    "duration_hours": 3
  }
  ```
- **Опис:** 
  - Максимум 80 кг за раз
  - Витрата води: до 1.5 куба на промивку

#### Крок 4: Сушка 1 (початкова)
- **Тип:** `dry`
- **Тривалість:** 1 день
- **Параметри:**
  ```json
  {
    "type": "initial"
  }
  ```
- **Опис:** Початкова сушка після промивки

#### Крок 5: Прес 1
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:**
  ```json
  {
    "press_number": 1
  }
  ```
- **Опис:** Перше пресування

#### Крок 6: Сушка 2 (перед чаманом)
- **Тип:** `dry`
- **Тривалість:** 4 дні
- **Параметри:**
  ```json
  {
    "type": "before_chaman",
    "days_min": 3,
    "days_max": 4
  }
  ```
- **Опис:** Сушка 3-4 дні перед нанесенням чаману

#### Крок 7: Нанесення чаману ⭐
- **Тип:** `mix`
- **Тривалість:** 0 днів (миттєво)
- **Параметри:**
  ```json
  {
    "mix_type": "chaman",
    "mix_id": 134
  }
  ```
- **Опис:**
  - **Контрольне зважування перед нанесенням!**
  - Виробництво чаману з пажитником
  - Правило води: 4 л води на 1 кг пажитника
  - ProducedMix = Σ специй + пажитник + (пажитник × 4 води)
  - Залишок чаману зважується і приходується на склад (ID: 134)

#### Крок 8: Сушка фінальна
- **Тип:** `dry`
- **Тривалість:** 4 дні
- **Параметри:**
  ```json
  {
    "type": "final",
    "days_min": 3,
    "days_max": 4
  }
  ```
- **Опис:** Фінальна сушка 3-4 дні після чаману

**Загальна тривалість:** ~12-13 днів + час на чаман

---

## 2. Бастурма з конини вагова

**Готовий продукт:** Бастурма з конини вагова (ID: 108)  
**Очікуваний вихід:** 67-68%  
**Сировина:** Конина вищий гатунок

### Технологічний процес (10 кроків):

#### Крок 1: Обрізка та підготовка
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:** `{}`

#### Крок 2: Засолка
- **Тип:** `salt`
- **Тривалість:** 3 дні
- **Параметри:**
  ```json
  {
    "salt_per_100kg": 20.67,
    "water_per_100kg": 66.67
  }
  ```
- **Опис:** Ідентично класичній бастурмі, приріст 7-10%

#### Крок 3: Промивка
- **Тип:** `wash`
- **Тривалість:** 0.125 днів (3 години)
- **Параметри:**
  ```json
  {
    "duration_hours": 3
  }
  ```
- **Опис:** До 1.5 куба води на 80 кг

#### Крок 4: Сушка 1
- **Тип:** `dry`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 5: Масажер з цукром ⭐
- **Тип:** `sugar`
- **Тривалість:** 0.083 днів (2 години)
- **Параметри:**
  ```json
  {
    "sugar_per_kg": 20
  }
  ```
- **Опис:** 
  - Унікальний крок тільки для конини!
  - 20 г цукру на 1 кг м'яса
  - Масажер працює 2 години

#### Крок 6: В'ялення
- **Тип:** `dry`
- **Тривалість:** 1 день
- **Параметри:** `{}`
- **Опис:** В'ялення в сушилці після цукру

#### Крок 7: Прес 1
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 8: Сушка 2
- **Тип:** `dry`
- **Тривалість:** 4 дні
- **Параметри:**
  ```json
  {
    "days_min": 3,
    "days_max": 4
  }
  ```

#### Крок 9: Нанесення маринаду конь ⭐
- **Тип:** `mix`
- **Тривалість:** 0 днів
- **Параметри:**
  ```json
  {
    "mix_type": "marinade_horse",
    "mix_id": 135
  }
  ```
- **Опис:**
  - **Контрольне зважування!**
  - Спеціальний маринад для конини (не чаман!)
  - Може містити пажитник → правило води 1:4
  - Залишок приходується на склад (ID: 135)

#### Крок 10: Сушка фінальна
- **Тип:** `dry`
- **Тривалість:** 4 дні
- **Параметри:**
  ```json
  {
    "days_min": 3,
    "days_max": 4
  }
  ```

**Загальна тривалість:** ~13-14 днів  
**Особливість:** Додатковий крок з цукром + свій маринад

---

## 3. Індичка сиров'ялена вагова

**Готовий продукт:** Індичка сиров'ялена вагова (ID: 129)  
**Очікуваний вихід:** 58-61%  
**Сировина:** Індик філе

### Технологічний процес (5 кроків):

#### Крок 1: Обрізка філе
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:**
  ```json
  {
    "trim_percent_min": 7,
    "trim_percent_max": 10
  }
  ```
- **Опис:** Обрізки складають 7-10% від початкової ваги

#### Крок 2: Виготовлення маринаду
- **Тип:** `marinade`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Склад: соль нітритна, дозривач, біопак-р, карі, часник, паприка
  - Виготовляється окремо

#### Крок 3: Вакуумна фасовка та маринування
- **Тип:** `vacuum`
- **Тривалість:** 6 днів
- **Параметри:**
  ```json
  {
    "marinate_days_min": 5,
    "marinate_days_max": 6
  }
  ```
- **Опис:**
  - Філе фасується з маринадом по 3 кг у вакуумні пакети
  - Маринується в холодильнику 5-6 днів

#### Крок 4: Пресування
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 5: Сушка
- **Тип:** `dry`
- **Тривалість:** 5 днів
- **Параметри:**
  ```json
  {
    "days_min": 3,
    "days_max": 5
  }
  ```
- **Опис:** Сушка 3-5 днів в сушилці

**Загальна тривалість:** ~12-13 днів  
**Особливість:** Найбільші обрізки (7-10%), вакуумне маринування

---

## 4. Курка сиров'ялена вагова

**Готовий продукт:** Курка сиров'ялена вагова (ID: 130)  
**Очікуваний вихід:** 53-55%  
**Сировина:** Курка філе

### Технологічний процес (5 кроків):

#### Крок 1: Обрізка філе
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:**
  ```json
  {
    "trim_percent_min": 22,
    "trim_percent_max": 25
  }
  ```
- **Опис:** **Найбільші обрізки серед усіх рецептів - 22-25%!**

#### Крок 2: Виготовлення маринаду
- **Тип:** `marinade`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Склад: соль нітритна, дозривач, біопак-р, карі, часник, суміш спецій прованс
  - Відрізняється від індички (прованс замість паприки)

#### Крок 3: Вакуумна фасовка та маринування
- **Тип:** `vacuum`
- **Тривалість:** 5 днів
- **Параметри:**
  ```json
  {
    "marinate_days_min": 4,
    "marinate_days_max": 5
  }
  ```
- **Опис:** По 3 кг у вакуумі, маринується 4-5 днів (менше ніж індичка)

#### Крок 4: Пресування
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 5: Сушка
- **Тип:** `dry`
- **Тривалість:** 3 дні
- **Параметри:**
  ```json
  {
    "days_min": 2,
    "days_max": 3
  }
  ```
- **Опис:** Найкоротша сушка - 2-3 дні

**Загальна тривалість:** ~9-10 днів  
**Особливість:** Найбільші втрати (47-53% через обрізки + сушку)

---

## 5. Свинина сиров'ялена вагова

**Готовий продукт:** Свинина сиров'ялена вагова (ID: 131)  
**Очікуваний вихід:** 62-64%  
**Сировина:** Свинина биток

### Технологічний процес (5 кроків):

#### Крок 1: Обрізка
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:**
  ```json
  {
    "trim_percent_min": 15,
    "trim_percent_max": 20
  }
  ```
- **Опис:** Середні обрізки 15-20%

#### Крок 2: Виготовлення маринаду
- **Тип:** `marinade`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Склад: соль нітритна, дозривач, біопак-р, суміш спецій угорська, часник, вода
  - Містить воду на відміну від птиці

#### Крок 3: Вакуумна фасовка та маринування
- **Тип:** `vacuum`
- **Тривалість:** 6 днів
- **Параметри:**
  ```json
  {
    "marinate_days_min": 5,
    "marinate_days_max": 6
  }
  ```
- **Опис:** По 3 кг, маринується 5-6 днів

#### Крок 4: Пресування
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 5: Сушка
- **Тип:** `dry`
- **Тривалість:** 6 днів
- **Параметри:**
  ```json
  {
    "days_min": 5,
    "days_max": 6
  }
  ```
- **Опис:** Найдовша сушка серед вакуумних - 5-6 днів

**Загальна тривалість:** ~13-14 днів  
**Особливість:** Найдовша сушка серед вакуумних продуктів

---

## 6. Пластина яловичина вагова

**Готовий продукт:** Пластина яловичина вагова (ID: 132)  
**Очікуваний вихід:** 53-56%  
**Сировина:** Яловичина вищій ґатунок + Яловичина перший ґатунок

### Технологічний процес (5 кроків):

#### Крок 1: Обрізка та підготовка
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:** Використовується суміш двох гатунків яловичини

#### Крок 2: Виготовлення маринаду
- **Тип:** `marinade`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Склад: соль нітритна, дозривач, біопак-р, суміш спецій гусарська, часник, вода

#### Крок 3: Вакуумна фасовка та маринування
- **Тип:** `vacuum`
- **Тривалість:** 6 днів
- **Параметри:**
  ```json
  {
    "marinate_days_min": 4,
    "marinate_days_max": 6
  }
  ```
- **Опис:** По 3 кг, маринується 4-6 днів (широкий діапазон)

#### Крок 4: Пресування
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 5: Сушка
- **Тип:** `dry`
- **Тривалість:** 3 дні
- **Параметри:**
  ```json
  {
    "days_min": 2,
    "days_max": 3
  }
  ```
- **Опис:** Коротка сушка 2-3 дні

**Загальна тривалість:** ~10-11 днів  
**Особливість:** Використовується два гатунки яловичини, гусарська суміш

---

## 7. Суджук ваговий

**Готовий продукт:** Суджук ваговий (ID: 110)  
**Очікуваний вихід:** 60-62%  
**Сировина:** Яловичина другий ґатунок (може бути + вищий, гуляш, залишки)

### Технологічний процес (10 кроків):

#### Крок 1: Підготовка м'яса
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Використовується: другий гатунок, вищий, гуляш (залишки від бастурми), залишки від конини, перший гатунок

#### Крок 2: Замішування зі специями
- **Тип:** `marinade_spices`
- **Тривалість:** 2 дні
- **Параметри:** `{}`
- **Опис:**
  - Специї: перець чорний (молимо самі!), зира, сіль, часник
  - Маринується 2 доби

#### Крок 3: Помол м'яса
- **Тип:** `grind`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:** М'ясо проходить через м'ясорубку після маринування

#### Крок 4: Масажер з водою та барвником ⭐
- **Тип:** `massage`
- **Тривалість:** 0 днів
- **Параметри:**
  ```json
  {
    "water_per_100kg": 15
  }
  ```
- **Опис:**
  - Додається вода: 15 л на 100 кг
  - Додається барвник: 250 г на 100 кг
  - Масажер

#### Крок 5: Заправка в кишку ⭐
- **Тип:** `stuff`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - **Кишка 1:** 93 метри, діаметр 48+ мм → влазить 100 кг м'яса
  - **Кишка 2:** 65 метрів, діаметр 53+ мм → влазить 100 кг м'яса

#### Крок 6: Сушка 1
- **Тип:** `dry`
- **Тривалість:** 3 дні
- **Параметри:** `{}`

#### Крок 7: Прес 1
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`

#### Крок 8: Сушка 2
- **Тип:** `dry`
- **Тривалість:** 2 дні
- **Параметри:**
  ```json
  {
    "days_min": 1,
    "days_max": 2
  }
  ```

#### Крок 9: Прес 2
- **Тип:** `press`
- **Тривалість:** 1 день
- **Параметри:** `{}`
- **Опис:** Унікально - два пресування!

#### Крок 10: Сушка фінальна
- **Тип:** `dry`
- **Тривалість:** 4 дні
- **Параметри:**
  ```json
  {
    "days_min": 3,
    "days_max": 4
  }
  ```

**Загальна тривалість:** ~13-14 днів  
**Особливість:** 
- Найскладніший рецепт (10 кроків)
- Два пресування
- Помол м'яса
- Заправка в кишку
- Використання різних залишків

---

## 8. Махан ваговий

**Готовий продукт:** Махан ваговий (ID: 111)  
**Очікуваний вихід:** 60-66%  
**Сировина:** Конина перший гатунок + обрізки + конський жир (10%) + гуляш від вищого гатунку

### Технологічний процес (6 кроків):

#### Крок 1: Підготовка конини
- **Тип:** `trim`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Конина перший гатунок
  - Обрізки
  - Конський жир - 10% від загальної ваги
  - Залишки гуляша від вищого гатунку

#### Крок 2: Перший маринад та масажер ⭐
- **Тип:** `marinade_first`
- **Тривалість:** 5 днів
- **Параметри:** `{}`
- **Опис:**
  - Склад: сіль, цукор, часник
  - Мішаємо в масажері
  - Відправляємо в холодильник
  - Дозріває 5 днів у холоді

#### Крок 3: Другий маринад з гусарською ⭐
- **Тип:** `marinade_second`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:**
  - Додаємо гусарську суміш спецій
  - Знову в масажер

#### Крок 4: Заправка в кишку/оболонку
- **Тип:** `stuff`
- **Тривалість:** 0 днів
- **Параметри:** `{}`
- **Опис:** М'ясо НЕ молемо (на відміну від суджука!)

#### Крок 5: В'ялення в холоді
- **Тип:** `cure`
- **Тривалість:** 10 днів
- **Параметри:** `{}`
- **Опис:** Довге в'ялення в холодних умовах

#### Крок 6: Сушка
- **Тип:** `dry`
- **Тривалість:** 10 днів
- **Параметри:** `{}`
- **Опис:** Довга фінальна сушка

**Загальна тривалість:** ~25 днів (найдовший цикл!)  
**Особливість:**
- Найдовший виробничий цикл
- Два різних маринади
- Довге в'ялення в холоді
- Конський жир у складі
- М'ясо НЕ молемо

---

## Типи кроків (step_type)

| Тип | Назва | Використовується в |
|-----|-------|-------------------|
| `trim` | Обрізка | Всі рецепти |
| `salt` | Засолка | Бастурма, Бастурма конини |
| `wash` | Промивка | Бастурма, Бастурма конини |
| `dry` | Сушка | Всі рецепти (багаторазово) |
| `press` | Пресування | Всі крім засолених (до мікса) |
| `mix` | Нанесення мікса | Бастурма (чаман), Бастурма конини (маринад) |
| `marinade` | Виготовлення маринаду | Індичка, Курка, Свинина, Пластина |
| `vacuum` | Вакуумна фасовка | Індичка, Курка, Свинина, Пластина |
| `sugar` | Масажер з цукром | Тільки Бастурма конини |
| `marinade_spices` | Замішування зі специями | Суджук |
| `grind` | Помол | Суджук |
| `massage` | Масажер з водою/барвником | Суджук |
| `stuff` | Заправка в кишку | Суджук, Махан |
| `marinade_first` | Перший маринад | Махан |
| `marinade_second` | Другий маринад | Махан |
| `cure` | В'ялення в холоді | Махан |

## Порівняльна таблиця

| Рецепт | Кроків | Днів | Вихід % | Особливості |
|--------|--------|------|---------|-------------|
| Бастурма класична | 8 | ~12-13 | 73-78 | Чаман, найвищий вихід |
| Бастурма конини | 10 | ~13-14 | 67-68 | Цукор, свій маринад |
| Індичка | 5 | ~12-13 | 58-61 | Вакуум, 7-10% обрізки |
| Курка | 5 | ~9-10 | 53-55 | Найбільші обрізки (22-25%) |
| Свинина | 5 | ~13-14 | 62-64 | Вакуум, довга сушка |
| Пластина | 5 | ~10-11 | 53-56 | Два гатунки м'яса |
| Суджук | 10 | ~13-14 | 60-62 | Помол, кишка, 2 преси |
| Махан | 6 | ~25 | 60-66 | Найдовший, жир 10%, 2 маринади |

## Спеціальні правила

### Правило пажитника (для чаману/маринаду)
```
Вода = Пажитник × 4

Якщо пажитника 1 кг → додається 4 літри води
ProducedMix = Σ інші специї + пажитник + 4л води
```

### Формули мікса
```
ProducedMix = Σ(всі специі) + (пажитник × 4 для води)
UsedMix = (ProducedMix - Leftover) + WarehouseMixUsed
```

### Облік матеріалів
- **Сировина** → списується при створенні партії
- **Специї** → списуються при виробництві мікса
- **Leftover мікса** → приходується на склад
- **Warehouse mix** → списується зі складу при використанні
- **Готова продукція** → приходується при завершенні партії

---

## API для роботи з рецептами

### Отримати рецепт з кроками
```http
GET /api/production/recipes/{recipe_id}
```

**Відповідь:**
```json
{
  "id": 2,
  "name": "Бастурма класична",
  "target_product_id": 133,
  "target_product_name": "Бастурма класична вагова",
  "expected_yield_min": 73.0,
  "expected_yield_max": 78.0,
  "steps": [
    {
      "id": 1,
      "step_order": 1,
      "step_type": "trim",
      "step_name": "Обрізка та підготовка",
      "duration_days": 0,
      "parameters": {"trim_percent_min": 0, "trim_percent_max": 0}
    },
    ...
  ]
}
```

### Створити партію
```http
POST /api/production/batches
{
  "recipe_id": 2,
  "initial_weight": 100.0,
  "trim_waste": 0,
  "trim_returned": false
}
```

### Додати операцію (завершити крок)
```http
POST /api/production/batches/{batch_id}/operations
{
  "step_id": 1,
  "weight_after": 98.5,
  "notes": "Обрізка завершена",
  "idempotency_key": "step-1-12345"
}
```

### Виробництво мікса
```http
POST /api/production/batches/{batch_id}/mix
{
  "mix_nomenclature_id": 134,
  "produced_quantity": 10.5,
  "used_quantity": 9.8,
  "leftover_quantity": 0.7,
  "warehouse_mix_used": 0,
  "idempotency_key": "mix-12345"
}
```

---

**Документ створено:** 2025  
**Версія:** 1.0  
**Статус:** Імплементовано та протестовано
